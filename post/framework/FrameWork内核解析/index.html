<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="王水泥">


    <meta name="subtitle" content="技术，etc">


    <meta name="description" content="不要传播">



<title>FrameWork内核解析 | 王水泥个人博客</title>



    <link rel="icon" href="/blog/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/blog/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/blog/js/script.js"></script>
    
    <script src="/blog/js/tocbot.min.js"></script>
    




<meta name="generator" content="Hexo 5.4.2"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/blog/">王水泥的博客</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/blog/archives">Posts</a>
                
                    <a class="menu-item" href="/blog/category">Categories</a>
                
                    <a class="menu-item" href="/blog/tag">Tags</a>
                
                    <a class="menu-item" href="/blog/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/blog/">王水泥的博客</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/blog/archives">Posts</a>
                
                    <a class="menu-item" href="/blog/category">Categories</a>
                
                    <a class="menu-item" href="/blog/tag">Tags</a>
                
                    <a class="menu-item" href="/blog/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">FrameWork内核解析</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">王水泥</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">十一月 1, 2022&nbsp;&nbsp;16:23:33</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/blog/categories/framework/">framework</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="FrameWork内核解析"><a href="#FrameWork内核解析" class="headerlink" title="FrameWork内核解析"></a>FrameWork内核解析</h1><p>[toc]</p>
<h2 id="XMS内核"><a href="#XMS内核" class="headerlink" title="XMS内核"></a>XMS内核</h2><h3 id="Activity的管理"><a href="#Activity的管理" class="headerlink" title="Activity的管理"></a>Activity的管理</h3><ol>
<li>ActivityRecord是Activity管理的最小单位，它对应着一个用户界面;</li>
<li>TaskRecord也是一个栈式管理结构，每一个TaskRecord都可能存在一个或多个ActivityRecord，栈顶的ActivityRecord表示当前可见的界面;</li>
<li>ActivityStack是一个栈式管理结构，每一个ActivityStack都可能存在一个或多个TaskRecord，栈顶的TaskRecord表示当前可见的任务;</li>
<li>ActivityStackSupervisor管理着多个ActivityStack，但当前只会有一个获取焦点(Focused)的ActivityStack;</li>
<li>ProcessRecord记录着属于一个进程的所有ActivityRecord，运行在不同TaskRecord中的ActivityRecord可能是属于同一个 ProcessRecord。<br><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606544572347.png" alt="Alt text"></li>
</ol>
<p><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606544578889.png" alt="1606544578889.png"></p>
<h3 id="Android插件化开发之运行未安装apk的activity"><a href="#Android插件化开发之运行未安装apk的activity" class="headerlink" title="Android插件化开发之运行未安装apk的activity"></a>Android插件化开发之运行未安装apk的activity</h3><p>我们知道PathClassLoader是一个应用的默认加载器(而且他只能加载data&#x2F;app&#x2F;xxx.apk的文件)，但是我们加载插件一般使用DexClassLoader加载器，所以这里就有问题了，其实如果对于开始的时候，每个人都会认为很简单，很容易想到使用DexClassLoader来加载Activity获取到class对象，在使用Intent启动</p>
<h4 id="替换LoadApk里面的mClassLoader"><a href="#替换LoadApk里面的mClassLoader" class="headerlink" title="替换LoadApk里面的mClassLoader"></a>替换LoadApk里面的mClassLoader</h4><p>我们知道我们可以将我们使用的DexClassLoader加载器绑定到系统加载Activity的类加载器上就可以了，这个是我们的思路。也是最重要的突破点。下面我们就来通过源码看看如何找到加载Activity的类加载器。加载Activity的时候，有一个很重要的类：LoadedApk.Java，这个类是负责加载一个Apk程序的，我们可以看一下他的源码：<br><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606545218330.png" alt="Alt text"><br>我们知道内部有个mClassLoader成员变量，我们只需要获取它就可以了，因为它不是静态的，所以我们需要先获取LoadApk这个类的对象，我们再去看看ActivityThread.java这个类。<br><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606545268969.png" alt="Alt text"><br>我们可以发现ActivityThread里面有个静态的成员变量sCurrentActivityThread,然后还有一个ArrayMap存放Apk包名和LoadedApk映射关系的数据结构，我们通过反射来获取mClassLoader对象。<br>如果对ActivityThread.java这个类不熟悉的可以看我这篇博客，<a target="_blank" rel="noopener" href="http://blog.csdn.net/u011068702/article/details/53207039">http://blog.csdn.net/u011068702/article/details/53207039</a> （Android插件化开发之AMS与应用程序(客户端ActivityThread、Instrumentation、Activity)通信模型分析)非常重要，是app程序的入口处。</p>
<h4 id="宿主代码"><a href="#宿主代码" class="headerlink" title="宿主代码"></a>宿主代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line">ReflectHelper.java  这个是的我的反射帮助类</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">package</span> com.example.dexclassloaderactivity;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 反射辅助函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span></span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectHelper</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] PARAM_TYPE_VOID = <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">invokeStaticMethod</span><span class="params">(String className, String methodName, Class&lt;?&gt;[] paramTypes, Object...params)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getMethod(methodName, paramTypes);</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="literal">null</span>, params);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">invokeMethod</span><span class="params">(String className, String methodName, Class&lt;?&gt;[] paramTypes, Object obj, Object...params)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getMethod(methodName, paramTypes);</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(obj, params);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getStaticField</span><span class="params">(String className, String fieldName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getField</span><span class="params">(String className, String fieldName, Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setStaticField</span><span class="params">(String className, String fieldName, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field.set(<span class="literal">null</span>, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setField</span><span class="params">(String className, String fieldName, Object obj, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field.set(obj, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">createInstance</span><span class="params">(String className, Class&lt;?&gt;[] paramTypes, Object...params)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; cls = Class.forName(className);</span><br><span class="line">            Constructor&lt;?&gt; constructor = cls.getConstructor(paramTypes);</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            object = constructor.newInstance(params);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Locates a given field anywhere in the class inheritance hierarchy.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> instance an object to search the field into.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name field name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a field object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchFieldException if the field cannot be located</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">findField</span><span class="params">(Object instance, String name)</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz = instance.getClass(); clazz != <span class="literal">null</span>; clazz = clazz.getSuperclass()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(name);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span> (!field.isAccessible()) &#123;</span><br><span class="line">                    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">return</span> field;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                <span class="comment">// ignore and search next</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchFieldException</span>(<span class="string">&quot;Field &quot;</span> + name + <span class="string">&quot; not found in &quot;</span> + instance.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Locates a given field anywhere in the class inheritance hierarchy.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  cls to search the field into.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name field name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a field object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchFieldException if the field cannot be located</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">findField2</span><span class="params">(Class&lt;?&gt; cls, String name)</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (clazz = cls; clazz != <span class="literal">null</span>; clazz = clazz.getSuperclass()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(name);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span> (!field.isAccessible()) &#123;</span><br><span class="line">                    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">return</span> field;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                <span class="comment">// ignore and search next</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchFieldException</span>(<span class="string">&quot;Field &quot;</span> + name + <span class="string">&quot; not found in &quot;</span> + clazz);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Locates a given method anywhere in the class inheritance hierarchy.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> instance an object to search the method into.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name method name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameterTypes method parameter types</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a method object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NoSuchMethodException if the method cannot be located</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Method <span class="title function_">findMethod</span><span class="params">(Object instance, String name, Class&lt;?&gt;... parameterTypes)</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; clazz = instance.getClass(); clazz != <span class="literal">null</span>; clazz = clazz.getSuperclass()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(name, parameterTypes);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span> (!method.isAccessible()) &#123;</span><br><span class="line">                    method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">return</span> method;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                <span class="comment">// ignore and search next</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Method &quot;</span> + name + <span class="string">&quot; with parameters &quot;</span> +</span><br><span class="line">                Arrays.asList(parameterTypes) + <span class="string">&quot; not found in &quot;</span> + instance.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MyApplication.java 这个类用实现替换mClassLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dexclassloaderactivity;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> dalvik.system.DexClassLoader;</span><br><span class="line"><span class="keyword">import</span> android.annotation.SuppressLint;</span><br><span class="line"><span class="keyword">import</span> android.app.Application;</span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"><span class="keyword">import</span> android.util.ArrayMap;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplication</span> <span class="keyword">extends</span> <span class="title class_">Application</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;MyApplication&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AppName</span> <span class="operator">=</span> <span class="string">&quot;test.apk&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DexClassLoader mClassLoader;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;替换之前系统的classLoader&quot;</span>);</span><br><span class="line">        showClassLoader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cachePath</span> <span class="operator">=</span> <span class="built_in">this</span>.getCacheDir().getAbsolutePath();</span><br><span class="line">            <span class="type">String</span> <span class="variable">apkPath</span> <span class="operator">=</span> <span class="comment">/*Environment.getExternalStorageState() + File.separator*/</span><span class="string">&quot;/sdcard/&quot;</span>+ AppName;</span><br><span class="line">            mClassLoader = <span class="keyword">new</span> <span class="title class_">DexClassLoader</span>(apkPath, cachePath,cachePath, getClassLoader()); </span><br><span class="line">            loadApkClassLoader(mClassLoader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;替换之后系统的classLoader&quot;</span>);</span><br><span class="line">        showClassLoader();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@SuppressLint(&quot;NewApi&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadApkClassLoader</span><span class="params">(DexClassLoader loader)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">currentActivityThread</span>  <span class="operator">=</span> ReflectHelper.invokeMethod(<span class="string">&quot;android.app.ActivityThread&quot;</span>, <span class="string">&quot;currentActivityThread&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;&#125;);</span><br><span class="line">            <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> <span class="built_in">this</span>.getPackageName();</span><br><span class="line">            <span class="type">ArrayMap</span> <span class="variable">mpackages</span> <span class="operator">=</span> (ArrayMap) ReflectHelper.getField(<span class="string">&quot;android.app.ActivityThread&quot;</span>, <span class="string">&quot;mPackages&quot;</span>, currentActivityThread);</span><br><span class="line">            WeakReference wr= (WeakReference)mpackages.get(packageName);</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;mClassLoader:&quot;</span> + wr.get());  </span><br><span class="line">            ReflectHelper.setField(<span class="string">&quot;android.app.LoadedApk&quot;</span>, <span class="string">&quot;mClassLoader&quot;</span>, wr.get(), loader);</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;load:&quot;</span> + loader);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;load apk classloader error:&quot;</span> + Log.getStackTraceString(e));  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打印系统的classLoader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showClassLoader</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> getClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="literal">null</span>)&#123;</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;[onCreate] classLoader &quot;</span> + i + <span class="string">&quot; : &quot;</span> + classLoader.toString());</span><br><span class="line">            <span class="keyword">while</span> (classLoader.getParent()!=<span class="literal">null</span>)&#123;</span><br><span class="line">                classLoader = classLoader.getParent();</span><br><span class="line">                Log.i(TAG,<span class="string">&quot;[onCreate] classLoader &quot;</span> + i + <span class="string">&quot; : &quot;</span> + classLoader.toString());</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就是MainActivity.java文件，里面包含了下面另外一种方式，打开activity，所以我把函数 inject(DexClassLoader loader)先注释掉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dexclassloaderactivity;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.ActionBarActivity;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.View.OnClickListener;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> dalvik.system.DexClassLoader;</span><br><span class="line"><span class="keyword">import</span> dalvik.system.PathClassLoader;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">ActionBarActivity</span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AppName</span> <span class="operator">=</span> <span class="string">&quot;test.apk&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">DexClassLoader</span> <span class="variable">mDexClassLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">APPName</span> <span class="operator">=</span> <span class="string">&quot;test.apk&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> TextView mText;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        findViewById(R.id.text2).setOnClickListener(<span class="keyword">new</span> <span class="title class_">OnClickListener</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                   inject(MyApplication.mClassLoader);</span></span><br><span class="line">                     <span class="type">String</span> <span class="variable">apkPath</span> <span class="operator">=</span> Environment.getExternalStorageDirectory().toString() + File.separator + APPName;</span><br><span class="line">                     <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> MyApplication.mClassLoader.loadClass(<span class="string">&quot;com.example.testapkdemo.MainActivity&quot;</span>);</span><br><span class="line">                     <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>, clazz);</span><br><span class="line">                     startActivity(intent);</span><br><span class="line">                     finish();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;name:&quot;</span> + Log.getStackTraceString(e));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(DexClassLoader loader)</span>&#123;  </span><br><span class="line">      </span><br><span class="line">        <span class="type">PathClassLoader</span> <span class="variable">pathLoader</span> <span class="operator">=</span> (PathClassLoader) getClassLoader();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">dexElements</span> <span class="operator">=</span> combineArray(  </span><br><span class="line">                    getDexElements(getPathList(pathLoader)),  </span><br><span class="line">                    getDexElements(getPathList(loader)));  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">pathList</span> <span class="operator">=</span> getPathList(pathLoader);  </span><br><span class="line">            setField(pathList, pathList.getClass(), <span class="string">&quot;dexElements&quot;</span>, dexElements);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getPathList</span><span class="params">(Object baseDexClassLoader)</span>  </span><br><span class="line">            <span class="keyword">throws</span> IllegalArgumentException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">bc</span> <span class="operator">=</span> (ClassLoader)baseDexClassLoader;  </span><br><span class="line">        <span class="keyword">return</span> getField(baseDexClassLoader, Class.forName(<span class="string">&quot;dalvik.system.BaseDexClassLoader&quot;</span>), <span class="string">&quot;pathList&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getField</span><span class="params">(Object obj, Class&lt;?&gt; cl, String field)</span>  </span><br><span class="line">            <span class="keyword">throws</span> NoSuchFieldException, IllegalArgumentException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">localField</span> <span class="operator">=</span> cl.getDeclaredField(field);  </span><br><span class="line">        localField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> localField.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getDexElements</span><span class="params">(Object paramObject)</span>  </span><br><span class="line">            <span class="keyword">throws</span> IllegalArgumentException, NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="keyword">return</span> getField(paramObject, paramObject.getClass(), <span class="string">&quot;dexElements&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setField</span><span class="params">(Object obj, Class&lt;?&gt; cl, String field,  </span></span><br><span class="line"><span class="params">            Object value)</span> <span class="keyword">throws</span> NoSuchFieldException,  </span><br><span class="line">            IllegalArgumentException, IllegalAccessException &#123;  </span><br><span class="line">      </span><br><span class="line">        <span class="type">Field</span> <span class="variable">localField</span> <span class="operator">=</span> cl.getDeclaredField(field);  </span><br><span class="line">        localField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        localField.set(obj, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">combineArray</span><span class="params">(Object arrayLhs, Object arrayRhs)</span> &#123;  </span><br><span class="line">        Class&lt;?&gt; localClass = arrayLhs.getClass().getComponentType();  </span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Array.getLength(arrayLhs);  </span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + Array.getLength(arrayRhs);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> Array.newInstance(localClass, j);  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; j; ++k) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (k &lt; i) &#123;  </span><br><span class="line">                Array.set(result, k, Array.get(arrayLhs, k));  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                Array.set(result, k, Array.get(arrayRhs, k - i));  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;   </span><br><span class="line">        <span class="keyword">return</span> result;  </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里一定要注意，我们犯了3个错，</p>
<p>1、test.apk的路径写错了，下次写文件路径的时候，我们应该需要加上File file &#x3D; new File(path); 用file.exist()函数来判断是否存在</p>
<p>2、从sdcard卡里面读取test.apk，没加上权限， <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/></p>
<p>3、写了Application,忘了在AndroidManifest.xml文件里面声明。</p>
<p>我们还需要注意要加上开启activity 在AndroidManifest.xml里面注册，切记，希望下次不要再次犯错。</p>
<p>AndroidManifest.xml文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.dexclassloaderactivity&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> &gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;11&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;21&quot;</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;com.example.dexclassloaderactivity.MyApplication&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span>   </span></span><br><span class="line"><span class="tag">                <span class="attr">android:name</span>=<span class="string">&quot;com.example.testapkdemo.MainActivity&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="合并PathClassLoader和DexClassLoader中的dexElements数组"><a href="#合并PathClassLoader和DexClassLoader中的dexElements数组" class="headerlink" title="合并PathClassLoader和DexClassLoader中的dexElements数组"></a>合并PathClassLoader和DexClassLoader中的dexElements数组</h3><p>我们首先来看一下PathClassLoader和DexClassLoader类加载器的父类BaseDexClassloader的源码：</p>
<p>(这里需要注意的是PathClassLoader和DexClassLoader类的父加载器是BaseClassLoader,他们的父类是BaseDexClassLoader)</p>
<p><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606553311219.png" alt="Alt text"><br><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606553320837.png" alt="Alt text"><br>Elements数组，我们看到这个变量他是专门存放加载的dex文件的路径的，系统默认的类加载器是PathClassLoader，本身一个程序加载之后会释放一个dex出来，这时候会将dex路径放到里面，当然DexClassLoader也是一样的，那么我们会想到，我们是否可以将DexClassLoader中的dexElements和PathClassLoader中的dexElements进行合并，然后在设置给PathClassLoader中呢？这也是一个思路。我们来看代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 以下是一种方式实现的</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loader</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(DexClassLoader loader)</span>&#123;</span><br><span class="line">    <span class="type">PathClassLoader</span> <span class="variable">pathLoader</span> <span class="operator">=</span> (PathClassLoader) getClassLoader();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">dexElements</span> <span class="operator">=</span> combineArray(</span><br><span class="line">                getDexElements(getPathList(pathLoader)),</span><br><span class="line">                getDexElements(getPathList(loader)));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">pathList</span> <span class="operator">=</span> getPathList(pathLoader);</span><br><span class="line">        setField(pathList, pathList.getClass(), <span class="string">&quot;dexElements&quot;</span>, dexElements);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getPathList</span><span class="params">(Object baseDexClassLoader)</span></span><br><span class="line">        <span class="keyword">throws</span> IllegalArgumentException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">bc</span> <span class="operator">=</span> (ClassLoader)baseDexClassLoader;</span><br><span class="line">    <span class="keyword">return</span> getField(baseDexClassLoader, Class.forName(<span class="string">&quot;dalvik.system.BaseDexClassLoader&quot;</span>), <span class="string">&quot;pathList&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getField</span><span class="params">(Object obj, Class&lt;?&gt; cl, String field)</span></span><br><span class="line">        <span class="keyword">throws</span> NoSuchFieldException, IllegalArgumentException, IllegalAccessException &#123;</span><br><span class="line">    <span class="type">Field</span> <span class="variable">localField</span> <span class="operator">=</span> cl.getDeclaredField(field);</span><br><span class="line">    localField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> localField.get(obj);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getDexElements</span><span class="params">(Object paramObject)</span></span><br><span class="line">        <span class="keyword">throws</span> IllegalArgumentException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">    <span class="keyword">return</span> getField(paramObject, paramObject.getClass(), <span class="string">&quot;dexElements&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setField</span><span class="params">(Object obj, Class&lt;?&gt; cl, String field,</span></span><br><span class="line"><span class="params">        Object value)</span> <span class="keyword">throws</span> NoSuchFieldException,</span><br><span class="line">        IllegalArgumentException, IllegalAccessException &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="type">Field</span> <span class="variable">localField</span> <span class="operator">=</span> cl.getDeclaredField(field);</span><br><span class="line">    localField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    localField.set(obj, value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">combineArray</span><span class="params">(Object arrayLhs, Object arrayRhs)</span> &#123;</span><br><span class="line">    Class&lt;?&gt; localClass = arrayLhs.getClass().getComponentType();</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Array.getLength(arrayLhs);</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + Array.getLength(arrayRhs);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> Array.newInstance(localClass, j);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; j; ++k) &#123;</span><br><span class="line">        <span class="keyword">if</span> (k &lt; i) &#123;</span><br><span class="line">            Array.set(result, k, Array.get(arrayLhs, k));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Array.set(result, k, Array.get(arrayRhs, k - i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后运行的时候把MyApplication.java文件里面的函数loadApkClassLoader(mClassLoader);注释掉，然后把MainActivity.java文件里面的inject(MyApplication.mClassLoader)不要注释，运行效果一样。</p>
<h2 id="WMS"><a href="#WMS" class="headerlink" title="WMS"></a>WMS</h2><p>WMS是系统的其他服务，无论对于应用开发还是Framework开发都是重点的知识，它的职责有很多，主要有以下几点：</p>
<ul>
<li><p>窗口管理<br>WMS是窗口的管理者，它负责窗口的启动、添加和删除，另外窗口的大小和层级也是由WMS进行管理的。窗口管理的核心成员有DisplayContent、WindowToken和WindowState。</p>
</li>
<li><p>窗口动画<br>窗口间进行切换时，使用窗口动画可以显得更炫一些，窗口动画由WMS的动画子系统来负责，动画子系统的管理者为WindowAnimator。</p>
</li>
<li><p>输入系统的中转站<br>通过对窗口的触摸从而产生触摸事件，InputManagerService（IMS）会对触摸事件进行处理，它会寻找一个最合适的窗口来处理触摸反馈信息，WMS是窗口的管理者，因此，WMS“理所应当”的成为了输入系统的中转站。</p>
</li>
<li><p>Surface管理<br>窗口并不具备有绘制的功能，因此每个窗口都需要有一块Surface来供自己绘制。为每个窗口分配Surface是由WMS来完成的。</p>
</li>
</ul>
<p>WMS的职责可以简单总结为下图。<br><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606553659149.png" alt="Alt text"></p>
<h3 id="WMS的诞生"><a href="#WMS的诞生" class="headerlink" title="WMS的诞生"></a>WMS的诞生</h3><p>WMS的知识点非常多，在了解这些知识点前，我们十分有必要知道WMS是如何产生的。WMS是在SyetemServer进程中启动的。先来查看SyetemServer的main方法：</p>
<p>frameworks&#x2F;base&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;SystemServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">SystemServer</span>().run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>main方法中只调用了SystemServer的run方法，如下所示。</p>
<p>frameworks&#x2F;base&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;SystemServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">          System.loadLibrary(<span class="string">&quot;android_servers&quot;</span>);<span class="comment">//1</span></span><br><span class="line">          ...</span><br><span class="line">          mSystemServiceManager = <span class="keyword">new</span> <span class="title class_">SystemServiceManager</span>(mSystemContext);<span class="comment">//2</span></span><br><span class="line">          mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);</span><br><span class="line">          LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line">          <span class="comment">// Prepare the thread pool for init tasks that can be parallelized</span></span><br><span class="line">          SystemServerInitThreadPool.get();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          traceEnd();  <span class="comment">// InitBeforeStartServices</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          traceBeginAndSlog(<span class="string">&quot;StartServices&quot;</span>);</span><br><span class="line">          startBootstrapServices();<span class="comment">//3</span></span><br><span class="line">          startCoreServices();<span class="comment">//4</span></span><br><span class="line">          startOtherServices();<span class="comment">//5</span></span><br><span class="line">          SystemServerInitThreadPool.shutdown();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">          Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;******************************************&quot;</span>);</span><br><span class="line">          Slog.e(<span class="string">&quot;System&quot;</span>, <span class="string">&quot;************ Failure starting system services&quot;</span>, ex);</span><br><span class="line">          <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          traceEnd();</span><br><span class="line">      &#125;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>run方法代码很多，这里截取了关键的部分，在注释1处加载了libandroid_servers.so。<br>在注释2处创建SystemServiceManager，它会对系统的服务进行创建、启动和生命周期管理。接下来的代码会启动系统的各种服务。<br>在注释3中的startBootstrapServices方法中用SystemServiceManager启动ActivityManagerService、PowerManagerService、PackageManagerService等服务。<br>在注释4处的方法中则启动了BatteryService、UsageStatsService和WebViewUpdateService。<br>注释5处的startOtherServices方法中则启CameraService、AlarmManagerService、VrManagerService等服务，这些服务的父类为SystemService。<br>从注释3、4、5的方法名称可以看出，官方把大概100多个系统服务分为了三种类型，分别是引导服务、核心服务和其他服务，其中其他服务为一些非紧要和一些不需要立即启动的服务，WMS就是其他服务的一种。我们来查看startOtherServices方法是如何启动WMS的：</p>
<p>frameworks&#x2F;base&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;SystemServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startOtherServices</span><span class="params">()</span> &#123;</span><br><span class="line"> ...</span><br><span class="line">            traceBeginAndSlog(<span class="string">&quot;InitWatchdog&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Watchdog</span> <span class="variable">watchdog</span> <span class="operator">=</span> Watchdog.getInstance();<span class="comment">//1</span></span><br><span class="line">            watchdog.init(context, mActivityManagerService);<span class="comment">//2</span></span><br><span class="line">            traceEnd();</span><br><span class="line">            traceBeginAndSlog(<span class="string">&quot;StartInputManagerService&quot;</span>);</span><br><span class="line">            inputManager = <span class="keyword">new</span> <span class="title class_">InputManagerService</span>(context);<span class="comment">//3</span></span><br><span class="line">            traceEnd();</span><br><span class="line">            traceBeginAndSlog(<span class="string">&quot;StartWindowManagerService&quot;</span>);</span><br><span class="line">            ConcurrentUtils.waitForFutureNoInterrupt(mSensorServiceStart, START_SENSOR_SERVICE);</span><br><span class="line">            mSensorServiceStart = <span class="literal">null</span>;</span><br><span class="line">            wm = WindowManagerService.main(context, inputManager,</span><br><span class="line">                    mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL,</span><br><span class="line">                    !mFirstBoot, mOnlyCore, <span class="keyword">new</span> <span class="title class_">PhoneWindowManager</span>());<span class="comment">//4</span></span><br><span class="line">            ServiceManager.addService(Context.WINDOW_SERVICE, wm);<span class="comment">//5</span></span><br><span class="line">            ServiceManager.addService(Context.INPUT_SERVICE, inputManager);<span class="comment">//6</span></span><br><span class="line">            traceEnd();   </span><br><span class="line">           ... </span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">            wm.displayReady();<span class="comment">//7</span></span><br><span class="line">               &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">&quot;making display ready&quot;</span>, e);</span><br><span class="line">              &#125;</span><br><span class="line">           ...</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">            wm.systemReady();<span class="comment">//8</span></span><br><span class="line">               &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            reportWtf(<span class="string">&quot;making Window Manager Service ready&quot;</span>, e);</span><br><span class="line">              &#125;</span><br><span class="line">            ...      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startOtherServices方法用于启动其他服务，其他服务大概有70多个，上面的代码只列出了WMS以及和它相关的IMS的启动逻辑，剩余的其他服务的启动逻辑也都大同小异。</p>
<p>在注释1、2处分别得到Watchdog实例并对它进行初始化，Watchdog用来监控系统的一些关键服务的运行状况，后文会再次提到它。<br>在注释3处创建了IMS，并赋值给IMS类型的inputManager对象。<br>注释4处执行了WMS的main方法，其内部会创建WMS，需要注意的是main方法其中一个传入的参数就是注释1处创建的IMS，WMS是输入事件的中转站，其内部包含了IMS引用并不意外。结合上文，我们可以得知WMS的main方法是运行在SystemServer的run方法中，换句话说就是运行在”system_server”线程”中，后面会再次提到”system_server”线程。<br>注释5和注释6处分别将WMS和IMS注册到ServiceManager中，这样如果某个客户端想要使用WMS，就需要先去ServiceManager中查询信息，然后根据信息与WMS所在的进程建立通信通路，客户端就可以使用WMS了。<br>注释7处用来初始化显示信息。<br>注释8处则用来通知WMS，系统的初始化工作已经完成，其内部调用了WindowManagerPolicy的systemReady方法。</p>
<p>我们来查看注释4处WMS的main方法，如下所示。</p>
<p>frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;wm&#x2F;WindowManagerService .java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> WindowManagerService <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> InputManagerService im,</span></span><br><span class="line"><span class="params">           <span class="keyword">final</span> <span class="type">boolean</span> haveInputMethods, <span class="keyword">final</span> <span class="type">boolean</span> showBootMsgs, <span class="keyword">final</span> <span class="type">boolean</span> onlyCore,</span></span><br><span class="line"><span class="params">           WindowManagerPolicy policy)</span> &#123;</span><br><span class="line">       DisplayThread.getHandler().runWithScissors(() -&gt;<span class="comment">//1</span></span><br><span class="line">               sInstance = <span class="keyword">new</span> <span class="title class_">WindowManagerService</span>(context, im, haveInputMethods, showBootMsgs,</span><br><span class="line">                       onlyCore, policy), <span class="number">0</span>);</span><br><span class="line">       <span class="keyword">return</span> sInstance;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>在注释2处创建了WMS的实例，这个过程运行在Runnable的run方法中，而Runnable则传入到了DisplayThread对应Handler的runWithScissors方法中，说明WMS的创建是运行在“android.display”线程中。需要注意的是，runWithScissors方法的第二个参数传入的是0，后面会提到。来查看Handler的runWithScissors方法里做了什么：</p>
<p>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;os&#x2F;Handler.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">runWithScissors</span><span class="params">(<span class="keyword">final</span> Runnable r, <span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;runnable must not be null&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;timeout must be non-negative&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (Looper.myLooper() == mLooper) &#123;<span class="comment">//1</span></span><br><span class="line">           r.run();</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">BlockingRunnable</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BlockingRunnable</span>(r);</span><br><span class="line">       <span class="keyword">return</span> br.postAndWait(<span class="built_in">this</span>, timeout);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>开头对传入的Runnable和timeout进行了判断，如果Runnable为null或者timeout小于0则抛出异常。注释1处根据每个线程只有一个Looper的原理来判断当前的线程（”system_server”线程）是否是Handler所指向的线程（”android.display”线程），如果是则直接执行Runnable的run方法，如果不是则调用BlockingRunnable的postAndWait方法，并将当前线程的Runnable作为参数传进去 ，BlockingRunnable是Handler的内部类，代码如下所示。</p>
<p>frameworks&#x2F;base&#x2F;core&#x2F;java&#x2F;android&#x2F;os&#x2F;Handler.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BlockingRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Runnable mTask;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> mDone;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">BlockingRunnable</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">            mTask = task;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mTask.run();<span class="comment">//1</span></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    mDone = <span class="literal">true</span>;</span><br><span class="line">                    notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">postAndWait</span><span class="params">(Handler handler, <span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!handler.post(<span class="built_in">this</span>)) &#123;<span class="comment">//2</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">expirationTime</span> <span class="operator">=</span> SystemClock.uptimeMillis() + timeout;</span><br><span class="line">                    <span class="keyword">while</span> (!mDone) &#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">delay</span> <span class="operator">=</span> expirationTime - SystemClock.uptimeMillis();</span><br><span class="line">                        <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// timeout</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            wait(delay);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (!mDone) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            wait();<span class="comment">//3</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>注释2处将当前的BlockingRunnable添加到Handler的任务队列中。前面runWithScissors方法的第二个参数为0，因此timeout等于0，这样如果mDone为false的话会一直调用注释3处的wait方法使得当前线程（”system_server”线程）进入等待状态，那么等待的是哪个线程呢？我们往上看，注释1处，执行了传入的Runnable的run方法（运行在”android.display”线程），执行完毕后在finally代码块中将mDone设置为true，并调用notifyAll方法唤醒处于等待状态的线程，这样就不会继续调用注释3处的wait方法。<br>因此得出结论，”system_server”线程线程等待的就是”android.display”线程，一直到”android.display”线程执行完毕再执行”system_server”线程，这是因为”android.display”线程内部执行了WMS的创建，显然WMS的创建优先级更高些。<br>WMS的创建就讲到这，最后我们来查看WMS的构造方法：</p>
<p>frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;wm&#x2F;WindowManagerService .java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">WindowManagerService</span><span class="params">(Context context, InputManagerService inputManager,</span></span><br><span class="line"><span class="params">         <span class="type">boolean</span> haveInputMethods, <span class="type">boolean</span> showBootMsgs, <span class="type">boolean</span> onlyCore, WindowManagerPolicy policy)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    mInputManager = inputManager;<span class="comment">//1</span></span><br><span class="line">    ...</span><br><span class="line">     mDisplayManager = (DisplayManager)context.getSystemService(Context.DISPLAY_SERVICE);</span><br><span class="line">     mDisplays = mDisplayManager.getDisplays();<span class="comment">//2</span></span><br><span class="line">     <span class="keyword">for</span> (Display display : mDisplays) &#123;</span><br><span class="line">         createDisplayContentLocked(display);<span class="comment">//3</span></span><br><span class="line">     &#125;</span><br><span class="line">    ...</span><br><span class="line">      mActivityManager = ActivityManager.getService();<span class="comment">//4</span></span><br><span class="line">    ...</span><br><span class="line">     mAnimator = <span class="keyword">new</span> <span class="title class_">WindowAnimator</span>(<span class="built_in">this</span>);<span class="comment">//5</span></span><br><span class="line">     mAllowTheaterModeWakeFromLayout = context.getResources().getBoolean(</span><br><span class="line">             com.android.internal.R.bool.config_allowTheaterModeWakeFromWindowLayout);</span><br><span class="line">     LocalServices.addService(WindowManagerInternal.class, <span class="keyword">new</span> <span class="title class_">LocalService</span>());</span><br><span class="line">     initPolicy();<span class="comment">//6</span></span><br><span class="line">     <span class="comment">// Add ourself to the Watchdog monitors.</span></span><br><span class="line">     Watchdog.getInstance().addMonitor(<span class="built_in">this</span>);<span class="comment">//7</span></span><br><span class="line">  ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>注释1处用来保存传进来的IMS，这样WMS就持有了IMS的引用。<br>注释2处通过DisplayManager的getDisplays方法得到Display数组（每个显示设备都有一个Display实例），接着遍历Display数组。<br>在注释3处的createDisplayContentLocked方法会将Display封装成DisplayContent，DisplayContent用来描述一快屏幕。<br>注释4处得到AMS实例，并赋值给mActivityManager ，这样WMS就持有了AMS的引用。<br>注释5处创建了WindowAnimator，它用于管理所有的窗口动画。<br>注释6处初始化了窗口管理策略的接口类WindowManagerPolicy（WMP），它用来定义一个窗口策略所要遵循的通用规范。<br>注释7处将自身也就是WMS通过addMonitor方法添加到Watchdog中，Watchdog用来监控系统的一些关键服务的运行状况（比如传入的WMS的运行状况），这些被监控的服务都会实现Watchdog.Monitor接口。Watchdog每分钟都会对被监控的系统服务进行检查，如果被监控的系统服务出现了死锁，则会杀死Watchdog所在的进程，也就是SystemServer进程。查看注释6处的initPolicy方法，如下所示。</p>
<p>frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;wm&#x2F;WindowManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initPolicy</span><span class="params">()</span> &#123;</span><br><span class="line">     UiThread.getHandler().runWithScissors(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">             WindowManagerPolicyThread.set(Thread.currentThread(), Looper.myLooper());</span><br><span class="line">             mPolicy.init(mContext, WindowManagerService.<span class="built_in">this</span>, WindowManagerService.<span class="built_in">this</span>);<span class="comment">//1</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;, <span class="number">0</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>initPolicy方法和此前讲的WMS的main方法的实现类似，注释1处执行了WMP的init方法，WMP是一个接口，init方法的具体实现在PhoneWindowManager（PWM）中。PWM的init方法运行在”android.ui”线程中，它优先级要高于initPolicy方法所在的”android.display”线程，因此”android.display”线程要等PWM的init方法执行完毕后，处于等待状态的”android.display”线程才会被唤醒从而继续执行下面的代码。</p>
<p>在本文中共提到了3个线程，分别是”system_server”、“android.display”和”android.ui”，为了便于理解，下面给出这三个线程之间的关系。<br><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606555128730.png" alt="Alt text"><br>system_server”线程中会调用WMS的main方法，main方法中会创建WMS，创建WMS的过程运行在”android.display”线程中，它的优先级更高一些，因此要等创建WMS完毕后才会唤醒处于等待状态的”system_server”线程。<br>WMS初始化时会执行initPolicy方法，initPolicy方法会调用PWM的init方法，这个init方法运行在”android.ui”线程，并且优先级更高，因此要先执行完PWM的init方法后，才会唤醒处于等待状态的”android.display”线程。<br>PWM的init方法执行完毕后会接着执行运行在”system_server”线程的代码，比如本文前部分提到WMS的<br>systemReady方法。</p>
<h2 id="PackageMS"><a href="#PackageMS" class="headerlink" title="PackageMS"></a>PackageMS</h2><p><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606555266447.png" alt="Alt text"><br> PackageMS启动过程</p>
<h3 id="SystemServer-java"><a href="#SystemServer-java" class="headerlink" title="SystemServer.java"></a>SystemServer.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startBootstrapServices</span><span class="params">()</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line">        ...</span><br><span class="line">        mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">            mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">        mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">        mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SystemServer-startOtherServices"><a href="#SystemServer-startOtherServices" class="headerlink" title="SystemServer::startOtherServices"></a>SystemServer::startOtherServices</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startOtherServices</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_LOCK_SETTINGS_READY);</span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</span><br><span class="line">    ...</span><br><span class="line">    mPackageManagerService.systemReady();</span><br><span class="line">    ...</span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PackageMS-main"><a href="#PackageMS-main" class="headerlink" title="PackageMS::main"></a>PackageMS::main</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title function_">main</span><span class="params">(Context context, Installer installer,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> factoryTest, <span class="type">boolean</span> onlyCore)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">PackageManagerService</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageManagerService</span>(context, installer,</span><br><span class="line">    ...</span><br><span class="line">    ServiceManager.addService(<span class="string">&quot;package&quot;</span>, m);</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PackageMS初始化"><a href="#PackageMS初始化" class="headerlink" title="PackageMS初始化"></a>PackageMS初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> factoryTest, <span class="type">boolean</span> onlyCore)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// PMS_START</span></span><br><span class="line">    <span class="comment">// A.1 创建Settings</span></span><br><span class="line">    mSettings = <span class="keyword">new</span> <span class="title class_">Settings</span>(mPackages);</span><br><span class="line">    <span class="comment">// A.2 system phone log nfc bluetooth shell 添加到Setting</span></span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.system&quot;</span>, Process.SYSTEM_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.phone&quot;</span>, RADIO_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.log&quot;</span>, LOG_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.nfc&quot;</span>, NFC_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.bluetooth&quot;</span>, BLUETOOTH_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.shell&quot;</span>, SHELL_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    ...</span><br><span class="line">    mPackageDexOptimizer = <span class="keyword">new</span> <span class="title class_">PackageDexOptimizer</span>(installer, mInstallLock, context,</span><br><span class="line">            <span class="string">&quot;*dexopt*&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// A.3 初始化SystemConfig</span></span><br><span class="line">    <span class="type">SystemConfig</span> <span class="variable">systemConfig</span> <span class="operator">=</span> SystemConfig.getInstance();</span><br><span class="line">    mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">    mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line">    mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mHandlerThread = <span class="keyword">new</span> <span class="title class_">ServiceThread</span>(TAG,</span><br><span class="line">                Process.THREAD_PRIORITY_BACKGROUND, <span class="literal">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">        mHandlerThread.start();</span><br><span class="line">        <span class="comment">// A.4 创建PackageHandler</span></span><br><span class="line">        mHandler = <span class="keyword">new</span> <span class="title class_">PackageHandler</span>(mHandlerThread.getLooper());</span><br><span class="line">        Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</span><br><span class="line">        ...</span><br><span class="line">        ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;libConfig.size(); i++) &#123;</span><br><span class="line">            mSharedLibraries.put(libConfig.keyAt(i),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">SharedLibraryEntry</span>(libConfig.valueAt(i), <span class="literal">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// PMS_SYSTEM_SCAN_START</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">bootClassPath</span> <span class="operator">=</span> System.getenv(<span class="string">&quot;BOOTCLASSPATH&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">systemServerClassPath</span> <span class="operator">=</span> System.getenv(<span class="string">&quot;SYSTEMSERVERCLASSPATH&quot;</span>);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// B.1 对满足调价的Jar Apk执行dex优化</span></span><br><span class="line">        mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet, dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>,</span><br><span class="line">                getCompilerFilterForReason(REASON_SHARED_APK), StorageManager.UUID_PRIVATE_INTERNAL, SKIP_SHARED_LIBRARY_CHECK);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// B.2 扫描system/app system/priv-app</span></span><br><span class="line">        <span class="comment">// Collect ordinary system packages.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">File</span> <span class="variable">systemAppDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(Environment.getRootDirectory(), <span class="string">&quot;app&quot;</span>);</span><br><span class="line">        scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Collect all OEM packages.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">File</span> <span class="variable">oemAppDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(Environment.getOemDirectory(), <span class="string">&quot;app&quot;</span>);</span><br><span class="line">        scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line">        ...</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//look for any incomplete package installations</span></span><br><span class="line">        ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">            <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">            <span class="comment">// reconciliation step</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> deletePkgsList.get(i).name;</span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">&quot;Cleaning up incompletely installed app: &quot;</span> + packageName);</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                mSettings.removePackageLPw(packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//delete tmp files</span></span><br><span class="line">        deleteTempPackageFiles();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Remove any shared userIDs that have no associated packages</span></span><br><span class="line">        mSettings.pruneSharedUsersLPw();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// PMS_DATA_SCAN_START</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//C.1 处理非系统App //data/app 、 自定义app路径</span></span><br><span class="line">        <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">            scanDirTracedLI(mAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line">            ...</span><br><span class="line"> </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Remove disable package settings for any updated system</span></span><br><span class="line"><span class="comment">             * apps that were removed via an OTA. If they&#x27;re not a</span></span><br><span class="line"><span class="comment">             * previously-updated app, remove them completely.</span></span><br><span class="line"><span class="comment">             * Otherwise, just revoke their system-level permissions.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</span><br><span class="line">                PackageParser.<span class="type">Package</span> <span class="variable">deletedPkg</span> <span class="operator">=</span> mPackages.get(deletedAppName);</span><br><span class="line">                mSettings.removeDisabledSystemPackageLPw(deletedAppName);</span><br><span class="line"> </span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Updated system app + &quot;</span> + deletedAppName</span><br><span class="line">                            + <span class="string">&quot; no longer present; removing system privileges for &quot;</span></span><br><span class="line">                            + deletedAppName;</span><br><span class="line"> </span><br><span class="line">                    deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">/// M: [Operator] Revoke operator permissions for the original operator package</span></span><br><span class="line">                    <span class="comment">/// under operator folder was gone due to OTA</span></span><br><span class="line">                    deletedPkg.applicationInfo.flagsEx &amp;= ~ApplicationInfo.FLAG_EX_OPERATOR;</span><br><span class="line"> </span><br><span class="line">                    <span class="type">PackageSetting</span> <span class="variable">deletedPs</span> <span class="operator">=</span> mSettings.mPackages.get(deletedAppName);</span><br><span class="line">                    deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line"> </span><br><span class="line">                    <span class="comment">/// M: [Operator] Revoke vendor permissions</span></span><br><span class="line">                    deletedPs.pkgFlagsEx &amp;= ~ApplicationInfo.FLAG_EX_OPERATOR;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Make sure all system apps that we expected to appear on</span></span><br><span class="line"><span class="comment">             * the userdata partition actually showed up. If they never</span></span><br><span class="line"><span class="comment">             * appeared, crawl back and revive the system version.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> mExpectingBetter.keyAt(i);</span><br><span class="line">                <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">scanFile</span> <span class="operator">=</span> mExpectingBetter.valueAt(i);</span><br><span class="line">                    ...</span><br><span class="line">                    scanPackageTracedLI(scanFile, reparseFlags, scanFlags, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// PMS_SCAN_END</span></span><br><span class="line">        <span class="comment">// D.1 回写package.xml</span></span><br><span class="line">        <span class="comment">// can downgrade to reader</span></span><br><span class="line">        mSettings.writeLPr();</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// PMS_READY</span></span><br><span class="line">        <span class="comment">// E1 创建PackageInstallerService</span></span><br><span class="line">        mInstallerService = <span class="keyword">new</span> <span class="title class_">PackageInstallerService</span>(context, <span class="built_in">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="comment">// synchronized (mPackages)</span></span><br><span class="line">    &#125; <span class="comment">// synchronized (mInstallLock)</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<h3 id="PackageMS-scanDirLi"><a href="#PackageMS-scanDirLi" class="headerlink" title="PackageMS::scanDirLi"></a>PackageMS::scanDirLi</h3><p><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606555427742.png" alt="Alt text"></p>
<h2 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//我们先来看看new Handler();时出错的原因。后续讲解源码分析只贴出关键部分。</span></span><br><span class="line"><span class="comment">//如下是Handler构造函数里抛出上文异常的地方，可以看到，由于mLooper对象为空才抛出的该异常。</span></span><br><span class="line">mLooper = Looper.myLooper();</span><br><span class="line">        <span class="keyword">if</span> (mLooper == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                <span class="string">&quot;Can&#x27;t create handler inside thread that has not called Looper.prepare()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  异常的原因看到了，接下来我们看看Looper.prepare()方法都干了些什么？</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">()</span> &#123;</span><br><span class="line">    prepare(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sThreadLocal.set(<span class="keyword">new</span> <span class="title class_">Looper</span>(quitAllowed));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 可以看到，该方法在当前thread创建了一个Looper(), ThreadLocal主要用于维护线程的本地变量，  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="keyword">private</span> <span class="title function_">Looper</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">    mQueue = <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(quitAllowed);</span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//而Looper的构造函数里面又为我们创建了一个MessageQueue()对象。</span></span><br></pre></td></tr></table></figure>
<p>了解到此，我们已经成功引出了Handler机制几个关键的对象了，Looper、MessageQueue、Message。<br>为什么在主线程中创建Handler不需要要用Looper.prepare()和Looper.loop()方法呢？<br>其实不是这样的，App初始化的时候都会执行ActivityThread的main方法，我们可以看看ActivityThread的main()方法都做了什么！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        <span class="type">ActivityThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ActivityThread</span>();</span><br><span class="line">        thread.attach(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (sMainThreadHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">            sMainThreadHandler = thread.getHandler();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">            Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                    <span class="title class_">LogPrinter</span>(Log.DEBUG, <span class="string">&quot;ActivityThread&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        Looper.loop();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 真相只有一个，是的在创建主线程的时候Android已经帮我们调用了Looper.prepareMainLooper()</span></span><br><span class="line"><span class="comment"> 和Looper.loop()方法，所以我们在主线程能直接创建Handler使用。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>如果不调用Looper.loop()方法，Handler是接受不到消息的，所以我们可以大胆的猜测，消息的获取肯定和它脱不了关系！当然关怀疑还不行，我们还必须找出真相来证明我们的猜想？那还等什么，先看看loop()方法吧。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//可以看到，在调用Looper.prepare()之前是不能调用该方法的，不然又得抛出异常了</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Looper</span> <span class="variable">me</span> <span class="operator">=</span> myLooper();</span><br><span class="line">        <span class="keyword">if</span> (me == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> me.mQueue;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">        <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">        Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ident</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> queue.next(); <span class="comment">// might block</span></span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Printer</span> <span class="variable">logging</span> <span class="operator">=</span> me.mLogging;</span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> +</span><br><span class="line">                        msg.callback + <span class="string">&quot;: &quot;</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">traceTag</span> <span class="operator">=</span> me.mTraceTag;</span><br><span class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                msg.target.dispatchMessage(msg);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                    Trace.traceEnd(traceTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> + msg.callback);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">            <span class="comment">// identity of the thread wasn&#x27;t corrupted.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">newIdent</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;Thread identity changed from 0x&quot;</span></span><br><span class="line">                        + Long.toHexString(ident) + <span class="string">&quot; to 0x&quot;</span></span><br><span class="line">                        + Long.toHexString(newIdent) + <span class="string">&quot; while dispatching to &quot;</span></span><br><span class="line">                        + msg.target.getClass().getName() + <span class="string">&quot; &quot;</span></span><br><span class="line">                        + msg.callback + <span class="string">&quot; what=&quot;</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            msg.recycleUnchecked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">这里我们看到，mLooper()方法里我们取出了，当前线程的looper对象，然后从looper对象开启了一个死循环 </span></span><br><span class="line"><span class="comment">不断地从looper内的MessageQueue中取出Message，只要有Message对象，就会通过Message的target调用</span></span><br><span class="line"><span class="comment">dispatchMessage去分发消息，通过代码可以看出target就是我们创建的handler。我们再继续往下分析。Message的分发</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatchMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="literal">null</span>) &#123;</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*好了，到这里已经能看清晰了</span></span><br><span class="line"><span class="comment">可以看到，如果我们设置了callback（Runnable对象）的话，则会直接调用handleCallback方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleCallback</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        message.callback.run();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//即，如果我们在初始化Handler的时候设置了callback（Runnable）对象，则直接调用run方法。比如我们经常写的runOnUiThread方法：</span></span><br><span class="line">runOnUiThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runOnUiThread</span><span class="params">(Runnable action)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (Thread.currentThread() != mUiThread) &#123;</span><br><span class="line">          mHandler.post(action);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          action.run();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">而如果msg.callback为空的话，会直接调用我们的mCallback.handleMessage(msg)，即handler的handlerMessage方法。由于Handler对象是在主线程中创建的，所以handler的handlerMessage方法的执行也会在主线程中。</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1、在使用handler的时候，在handler所创建的线程需要维护一个唯一的Looper对象， 每个线程对应一个Looper，每个线程的Looper通过ThreadLocal来保证，如需了解ThreadLocal，点击查看详细讲解 ,Looper对象的内部又维护有唯一的一个MessageQueue，所以一个线程可以有多个handler，但是只能有一个Looper和一个MessageQueue。</p>
<p>2、Message在MessageQueue不是通过一个列表来存储的，而是将传入的Message存入到了上一个Message的next中，在取出的时候通过顶部的Message就能按放入的顺序依次取出Message。</p>
<p>3、Looper对象通过loop()方法开启了一个死循环，不断地从looper内的MessageQueue中取出Message，然后通过handler将消息分发传回handler所在的线程。<br>最后附上一张自己理解画出来的流程图：<br><img src="https://uncle2000-blog.oss-cn-chengdu.aliyuncs.com/framework/.1606564030624.png" alt="Alt text"></p>
<h3 id="Handler补充："><a href="#Handler补充：" class="headerlink" title="Handler补充："></a>Handler补充：</h3><h4 id="Handler在使用过程中，需要注意的问题之一便是内存泄漏问题。"><a href="#Handler在使用过程中，需要注意的问题之一便是内存泄漏问题。" class="headerlink" title="Handler在使用过程中，需要注意的问题之一便是内存泄漏问题。"></a>Handler在使用过程中，需要注意的问题之一便是内存泄漏问题。</h4><p>首先Handler使用是用来进行线程间通信的，所以新开启的线程是会持有Handler引用的，如果在Activity等中创建Handler，并且是非静态内部类的形式，就有可能造成内存泄漏。非静态内部类是会隐式持有外部类的引用，所以当其他线程持有了该Handler，线程没有被销毁，则意味着Activity会一直被Handler持有引用而无法导致回收。同时，MessageQueue中如果存在未处理完的Message，Message的target也是对Activity等的持有引用，也会造成内存泄漏。<br>使用静态内部类+弱引用的方式:<br>静态内部类不会持有外部类的的引用，当需要引用外部类相关操作时，可以通过弱引用还获取到外部类相关操作，弱引用是不会造成对象该回收回收不掉的问题，不清楚的可以查阅JAVA的几种引用方式的详细说明</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">Handler</span> <span class="variable">sHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestHandler</span>(<span class="built_in">this</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TestHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> WeakReference&lt;Activity&gt; mActivity;</span><br><span class="line">    TestHandler(Activity activity) &#123;</span><br><span class="line">        mActivity = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(activity);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.handleMessage(msg);</span><br><span class="line">        <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> mActivity.get();</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//<span class="doctag">TODO:</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在外部类对象被销毁时，将MessageQueue中的消息清空。例如，在Activity的onDestroy时将消息清空。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Override</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    handler.removeCallbacksAndMessages(<span class="literal">null</span>);</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在使用Handler时，通常是通过Handler-obtainMessage-来获取Message对象的，而其内部调用的是Message-obtain-方法，那么问题来了，为什么不直接new一个Message，而是通过Message的静态方法obtain-来得到的呢？"><a href="#在使用Handler时，通常是通过Handler-obtainMessage-来获取Message对象的，而其内部调用的是Message-obtain-方法，那么问题来了，为什么不直接new一个Message，而是通过Message的静态方法obtain-来得到的呢？" class="headerlink" title="在使用Handler时，通常是通过Handler.obtainMessage()来获取Message对象的，而其内部调用的是Message.obtain()方法，那么问题来了，为什么不直接new一个Message，而是通过Message的静态方法obtain()来得到的呢？"></a>在使用Handler时，通常是通过Handler.obtainMessage()来获取Message对象的，而其内部调用的是Message.obtain()方法，那么问题来了，为什么不直接new一个Message，而是通过Message的静态方法obtain()来得到的呢？</h3><p>下面就通过代码来一探究竟</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title function_">obtain</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sPoolSync) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sPool != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">m</span> <span class="operator">=</span> sPool;</span><br><span class="line">                sPool = m.next;</span><br><span class="line">                m.next = <span class="literal">null</span>;</span><br><span class="line">                m.flags = <span class="number">0</span>; <span class="comment">// clear in-use flag</span></span><br><span class="line">                sPoolSize--;</span><br><span class="line">                <span class="keyword">return</span> m;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>其实在在Message中有一个static Message变量sPool，这个变量是用于缓存Message对象的，在obtain中可以看到当需要一个Message对象时，如果sPool不为空则会返回当前sPool（Message），而将sPool指向了之前sPool的next对象，（之前讲MessageQueue时讲过Message的存储是以链式的形式存储的，通过Message的next指向下一个Message，这里就是返回了sPool当前这个Message，然后sPool重新指向了其下一个Message），然后将返回的Message的next指向置为空（断开链表），sPoolSize记录了当前缓存的Message的数量，如果sPool为空，则没有缓存的Message，则需要创建一个新的Message（new Message）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recycle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isInUse()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (gCheckRecycle) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;This message cannot be recycled because it &quot;</span></span><br><span class="line">                        + <span class="string">&quot;is still in use.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        recycleUnchecked();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">void</span> <span class="title function_">recycleUnchecked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Mark the message as in use while it remains in the recycled object pool.</span></span><br><span class="line">        <span class="comment">// Clear out all other details.</span></span><br><span class="line">        flags = FLAG_IN_USE;</span><br><span class="line">        what = <span class="number">0</span>;</span><br><span class="line">        arg1 = <span class="number">0</span>;</span><br><span class="line">        arg2 = <span class="number">0</span>;</span><br><span class="line">        obj = <span class="literal">null</span>;</span><br><span class="line">        replyTo = <span class="literal">null</span>;</span><br><span class="line">        sendingUid = -<span class="number">1</span>;</span><br><span class="line">        when = <span class="number">0</span>;</span><br><span class="line">        target = <span class="literal">null</span>;</span><br><span class="line">        callback = <span class="literal">null</span>;</span><br><span class="line">        data = <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">synchronized</span> (sPoolSync) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;</span><br><span class="line">                next = sPool;</span><br><span class="line">                sPool = <span class="built_in">this</span>;</span><br><span class="line">                sPoolSize++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>recycle()是回收Message的方法,在Message处理完或者清空Message等时会调用。<br>recycleUnchecked（）方法中可以看到，将what、arg1、arg2、object等都重置了值，如果当前sPool（Message缓存池）的大小小于允许缓存的Message最大数量时，将要回收的Message的next指向sPool，将sPool指向了回收的Message对象（即将Message放到了sPool缓存池的头部）</p>
<h2 id="LayoutManager"><a href="#LayoutManager" class="headerlink" title="LayoutManager"></a>LayoutManager</h2><h3 id="onLayoutChildren"><a href="#onLayoutChildren" class="headerlink" title="onLayoutChildren"></a>onLayoutChildren</h3><p>相当于ViewGroup的 onLayout.一开始的界面构建就是这个入口</p>
<p>1 在RecyclerView初始化时，会被调用两次。<br>2 在调用adapter.notifyDataSetChanged()时，会被调用。<br>3 在调用setAdapter替换Adapter时,会被调用。<br>4 在RecyclerView执行动画时，它也会被调<br>onLayoutChildren中的流程</p>
<p>报废当前的View<br>获取对应位置的子view<br>添加进RecyclerView<br>测量子View的宽高<br>根据测量的宽高,给他们排列好位置<br>注意,这一版本是没考虑缓存,全一股脑添加进RecyclerView的,目的是熟悉代码为后面铺垫<br>其中的函数</p>
<p>detachAndScrapAttachedViews : 是将当前Recycler中的view全部移除并放到报废缓存里,之后优先重用缓存里的view<br>getDecoratedMeasuredWidth&#x2F;getDecoratedMeasuredHeight 获取宽高,这个是加上了DecorateView<br>的,现在没有 RecyclerView.addItemDecoration();直接理解为宽高就行<br>layoutDecorated就是用来个子View排位置的<br>actualHeight记录了目前的高度,为了实现LinearLayoutManager的垂直排序来的<br>然后看看具体代码吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (getItemCount() == <span class="number">0</span>)&#123;</span><br><span class="line">            detachAndScrapAttachedViews(recycler);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//state.isPreLayout()是支持动画的</span></span><br><span class="line">        <span class="keyword">if</span> (getItemCount() == <span class="number">0</span> &amp;&amp; state.isPreLayout())&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        detachAndScrapAttachedViews(recycler);</span><br><span class="line"> </span><br><span class="line">        actualHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ;i &lt; getItemCount() ; i++)&#123;</span><br><span class="line">            <span class="type">View</span> <span class="variable">scrap</span> <span class="operator">=</span> recycler.getViewForPosition(i);</span><br><span class="line">            addView(scrap);</span><br><span class="line">            measureChildWithMargins(scrap,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> getDecoratedMeasuredWidth(scrap);</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> getDecoratedMeasuredHeight(scrap);</span><br><span class="line">            layoutDecorated(scrap,<span class="number">0</span>,actualHeight,width,actualHeight+height);</span><br><span class="line">            actualHeight+=height;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>滑动<br>canScrollVertically返回true就是可以垂直滑动<br>scrollVerticallyBy是滑动具体的逻辑<br>scrollVerticallyBy的参数要说明下<br>参数:<br>dy : 是当前滑动的距离,界面向下滚动的时候,dy为正,向上滚动的时候dy为负<br>返回的值: 如果Math.abs(返回值)小于dy,说明到达边界了,这里简单的处理下,如果到达边界了直接返回0</p>
<p>逻辑<br>通过totalScrollY来记录已经滑动的总距离<br>向下滚动的时候,如果总距离超过了子view的总高度-屏幕高度,说明到达下边界了<br>向上滚动的时候,如果总距离小于等于0,就是到达了上边界<br>其他就是正常情况了,使用offsetChildrenVertical来滚动界面<br>具体如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canScrollVertically</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">scrollVerticallyBy</span><span class="params">(<span class="type">int</span> dy, RecyclerView.Recycler recycler, RecyclerView.State state)</span> &#123;</span><br><span class="line">        <span class="comment">//界面向下滚动的时候,dy为正,向上滚动的时候dy为负</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//向下滚动的时候,最下面的值不能超过总值,</span></span><br><span class="line">        <span class="comment">//向上滚动的时候,最上面的值不能小于0</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">willScrollTo</span> <span class="operator">=</span> totalScrollY + dy;</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;scrollVerticallyBy &quot;</span> + dy + <span class="string">&quot; totalScrollY &quot;</span> + totalScrollY);</span><br><span class="line">        <span class="keyword">if</span> (willScrollTo &gt;= actualHeight-getHeight())&#123;</span><br><span class="line">            offsetChildrenVertical(-<span class="number">1</span>*(actualHeight - getHeight() - totalScrollY));</span><br><span class="line">            totalScrollY = actualHeight- getHeight();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (willScrollTo &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            offsetChildrenVertical(totalScrollY);</span><br><span class="line">            totalScrollY = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        offsetChildrenVertical(dy*-<span class="number">1</span>);</span><br><span class="line">        totalScrollY +=dy;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> dy;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>加入回收功能<br>其实就是基于上边的简陋版本进行扩展</p>
<p>onLayoutChildren的时候不添加全部view,只添加可视范围内的View<br>滑动的时候要更复杂一点<br>如果向下滚动,先往RecyclerView下面添加即将展示的View<br>如果往上滚动,就往RecyclerView上面添加即将展示的View<br>添加完View后就调用offsetChildrenVertical进行滚动<br>完了后检查是否有子View离开了可视界面,如果不可见了,就是用removeAndRecycleView来移除掉<br>onLayoutChildren<br>与之前不同的就是最后几句,如果超过RecyclerView的高度了,就不Add了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state)</span> &#123;</span><br><span class="line">       Log.d(TAG,<span class="string">&quot;onLayoutChildren &quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (getItemCount() == <span class="number">0</span>)&#123;</span><br><span class="line">           detachAndScrapAttachedViews(recycler);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//state.isPreLayout()是支持动画的</span></span><br><span class="line">       <span class="keyword">if</span> (getItemCount() == <span class="number">0</span> &amp;&amp; state.isPreLayout())&#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//将当前Recycler中的view全部移除并放到报废缓存里,之后优先重用缓存里的view</span></span><br><span class="line">       detachAndScrapAttachedViews(recycler);</span><br><span class="line"></span><br><span class="line">       <span class="type">int</span> <span class="variable">actualHeight</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ;i &lt; getItemCount() ; i++)&#123;</span><br><span class="line">           <span class="type">View</span> <span class="variable">scrap</span> <span class="operator">=</span> recycler.getViewForPosition(i);</span><br><span class="line">           addView(scrap);</span><br><span class="line">           measureChildWithMargins(scrap,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">           <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> getDecoratedMeasuredWidth(scrap);</span><br><span class="line">           <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> getDecoratedMeasuredHeight(scrap);</span><br><span class="line">           layoutDecorated(scrap,<span class="number">0</span>,actualHeight,width,actualHeight+height);</span><br><span class="line">           actualHeight+=height;</span><br><span class="line">           <span class="comment">//超出界面的就不画了,也不add了</span></span><br><span class="line">           <span class="keyword">if</span> (actualHeight &gt; getHeight())&#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>scrollVerticallyBy<br>之前说了,分为填充,滚动,回收</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">scrollVerticallyBy</span><span class="params">(<span class="type">int</span> dy, RecyclerView.Recycler recycler, RecyclerView.State state)</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;getChildCount() &quot;</span> + getChildCount() + <span class="string">&quot; recycler.getScrapList().size() &quot;</span> + recycler.getScrapList().size());</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//界面向下滚动的时候,dy为正,向上滚动的时候dy为负</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//向下滚动的时候,最下面的值不能超过总值,</span></span><br><span class="line">        <span class="comment">//向上滚动的时候,最上面的值不能小于0</span></span><br><span class="line">   </span><br><span class="line">        <span class="comment">//填充</span></span><br><span class="line">        fill(dy,recycler,state);</span><br><span class="line">        <span class="comment">//滚动</span></span><br><span class="line">        offsetChildrenVertical(dy*-<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//回收已经离开界面的</span></span><br><span class="line">        recycleOut(dy,recycler,state);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> dy;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>填充<br>例如向下滚动</p>
<p>通过getChildAt获取最后一个View<br>再通过getPosition获取这个View的Adapter中的位置,最后一个了,就不要继续填充了,因为没有了,如果有下一个,就继续<br>这里还没有滑动,但是即将滑动的距离dy传进来了,如果最后一个View滑动dy后小于RecyclerView的高度了说明最后一个View已经全部出现在界面上了,之后就是空白了,需要添加新的子View<br>那就做获取,测量,添加操作<br>向上滚动是一样的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fill</span><span class="params">(<span class="type">int</span> dy, RecyclerView.Recycler recycler, RecyclerView.State state)</span>&#123;</span><br><span class="line">        <span class="comment">//向下滚动</span></span><br><span class="line">        <span class="keyword">if</span> (dy &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//先在底部填充</span></span><br><span class="line">            <span class="type">View</span>  <span class="variable">lastView</span> <span class="operator">=</span> getChildAt(getChildCount() -<span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">lastPos</span> <span class="operator">=</span> getPosition(lastView);</span><br><span class="line">            <span class="keyword">if</span> (lastPos == getChildCount()-<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;lastView top&quot;</span> + lastView.getTop() + <span class="string">&quot; bottom &quot;</span> + lastView.getBottom());</span><br><span class="line">            <span class="keyword">if</span> (lastView.getBottom() -  dy &lt; getHeight())&#123;</span><br><span class="line">                <span class="type">View</span> <span class="variable">scrap</span> <span class="operator">=</span> recycler.getViewForPosition(lastPos+<span class="number">1</span>);</span><br><span class="line">                addView(scrap);</span><br><span class="line">                measureChildWithMargins(scrap,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> getDecoratedMeasuredWidth(scrap);</span><br><span class="line">                <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> getDecoratedMeasuredHeight(scrap);</span><br><span class="line">                layoutDecorated(scrap,<span class="number">0</span>,lastView.getBottom(),width,lastView.getBottom()+height);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//向上滚动</span></span><br><span class="line">            <span class="comment">//现在顶部填充</span></span><br><span class="line">            <span class="type">View</span>  <span class="variable">firstView</span> <span class="operator">=</span> getChildAt(<span class="number">0</span>);</span><br><span class="line">            Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;firstView top&quot;</span> + firstView.getTop() + <span class="string">&quot; bottom &quot;</span> + firstView.getBottom());</span><br><span class="line">            <span class="type">int</span> <span class="variable">layoutPostion</span> <span class="operator">=</span> getPosition(firstView);</span><br><span class="line">            <span class="keyword">if</span> (layoutPostion == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (firstView.getTop() &gt;= <span class="number">0</span> )&#123;</span><br><span class="line">                <span class="type">View</span> <span class="variable">scrap</span> <span class="operator">=</span> recycler.getViewForPosition(layoutPostion -<span class="number">1</span>);</span><br><span class="line">                addView(scrap,<span class="number">0</span>);</span><br><span class="line">                measureChildWithMargins(scrap,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> getDecoratedMeasuredWidth(scrap);</span><br><span class="line">                <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> getDecoratedMeasuredHeight(scrap);</span><br><span class="line">                layoutDecorated(scrap,<span class="number">0</span>,firstView.getTop() - height,width,firstView.getTop());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>滚动<br>滚动就是直接用offsetChildrenVertical(dy*-1);但是需要和简陋版一样,需要搞定边界问题<br>例如: 到达上边界后,滑动的距离不是dy,而是第一个View还剩下多少距离可以滑动,代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">canScroll</span> <span class="operator">=</span> dy;</span><br><span class="line"><span class="keyword">if</span> (dy&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="type">View</span>  <span class="variable">lastView</span> <span class="operator">=</span> getChildAt(getChildCount() -<span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">lastPos</span> <span class="operator">=</span> getPosition(lastView);</span><br><span class="line">    <span class="keyword">if</span> (lastPos &gt;= getItemCount()-<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (lastView.getBottom() - dy &lt; getHeight())&#123;</span><br><span class="line">            canScroll = lastView.getBottom() - getHeight();</span><br><span class="line">            offsetChildrenVertical(canScroll*-<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">View</span>  <span class="variable">firView</span> <span class="operator">=</span> getChildAt(<span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">firstPos</span> <span class="operator">=</span> getPosition(firView);</span><br><span class="line">    <span class="keyword">if</span> (firstPos &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (firView.getTop() - dy &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">            canScroll = firView.getTop();</span><br><span class="line">            offsetChildrenVertical(canScroll*-<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回收<br>通过getChildCount() 获取当前所有的子View<br>例如向上滚动,name就回收最下面的,最下面的View的top滑动后超出了RecyclerView的高度,说明这个View全部在界面外了,可以回收了,使用removeAndRecycleView移除并回收<br>向下滚动就判断顶部的Bottom是否小于0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">recycleOut</span><span class="params">(<span class="type">int</span> dy, RecyclerView.Recycler recycler, RecyclerView.State state)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt;getChildCount() ;i++)&#123;</span><br><span class="line">        <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> getChildAt(i);</span><br><span class="line">        Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;recycleOut position &quot;</span>+ i + <span class="string">&quot; top &quot;</span> + view.getTop() + <span class="string">&quot; bottom &quot;</span> + view.getBottom());</span><br><span class="line">        <span class="keyword">if</span> (dy &gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (view.getBottom()-dy &lt;<span class="number">0</span>)&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;recycleOut &quot;</span> + i);</span><br><span class="line">                removeAndRecycleView(view,recycler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (view.getTop()-dy &gt; getHeight())&#123;</span><br><span class="line">                Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;recycleOut &quot;</span> + i);</span><br><span class="line">                removeAndRecycleView(view,recycler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样带回收的LayoutManager也完成了,全部代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 填充,滑动,回收</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLayoutManager2</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span>.LayoutManager &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> CustomLayoutManager2.class.getSimpleName();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RecyclerView.LayoutParams <span class="title function_">generateDefaultLayoutParams</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RecyclerView</span>.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT,ViewGroup.LayoutParams.WRAP_CONTENT);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//    1 在RecyclerView初始化时，会被调用两次。</span></span><br><span class="line"><span class="comment">//    2 在调用adapter.notifyDataSetChanged()时，会被调用。</span></span><br><span class="line"><span class="comment">//    3 在调用setAdapter替换Adapter时,会被调用。</span></span><br><span class="line"><span class="comment">//    4 在RecyclerView执行动画时，它也会被调用。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler, RecyclerView.State state)</span> &#123;</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;onLayoutChildren &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (getItemCount() == <span class="number">0</span>)&#123;</span><br><span class="line">            detachAndScrapAttachedViews(recycler);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//state.isPreLayout()是支持动画的</span></span><br><span class="line">        <span class="keyword">if</span> (getItemCount() == <span class="number">0</span> &amp;&amp; state.isPreLayout())&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将当前Recycler中的view全部移除并放到报废缓存里,之后优先重用缓存里的view</span></span><br><span class="line">        detachAndScrapAttachedViews(recycler);</span><br><span class="line"> </span><br><span class="line">        <span class="type">int</span> <span class="variable">actualHeight</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ;i &lt; getItemCount() ; i++)&#123;</span><br><span class="line">            <span class="type">View</span> <span class="variable">scrap</span> <span class="operator">=</span> recycler.getViewForPosition(i);</span><br><span class="line">            addView(scrap);</span><br><span class="line">            measureChildWithMargins(scrap,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> getDecoratedMeasuredWidth(scrap);</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> getDecoratedMeasuredHeight(scrap);</span><br><span class="line">            layoutDecorated(scrap,<span class="number">0</span>,actualHeight,width,actualHeight+height);</span><br><span class="line">            actualHeight+=height;</span><br><span class="line">            <span class="comment">//超出界面的就不画了,也不add了</span></span><br><span class="line">            <span class="keyword">if</span> (actualHeight &gt; getHeight())&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canScrollVertically</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">scrollVerticallyBy</span><span class="params">(<span class="type">int</span> dy, RecyclerView.Recycler recycler, RecyclerView.State state)</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;getChildCount() &quot;</span> + getChildCount() + <span class="string">&quot; recycler.getScrapList().size() &quot;</span> + recycler.getScrapList().size());</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//界面向下滚动的时候,dy为正,向上滚动的时候dy为负</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment">//向下滚动的时候,最下面的值不能超过总值,</span></span><br><span class="line">        <span class="comment">//向上滚动的时候,最上面的值不能小于0</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">canScroll</span> <span class="operator">=</span> dy;</span><br><span class="line">        <span class="keyword">if</span> (dy&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">View</span>  <span class="variable">lastView</span> <span class="operator">=</span> getChildAt(getChildCount() -<span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">lastPos</span> <span class="operator">=</span> getPosition(lastView);</span><br><span class="line">            <span class="keyword">if</span> (lastPos &gt;= getItemCount()-<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (lastView.getBottom() - dy &lt; getHeight())&#123;</span><br><span class="line">                    canScroll = lastView.getBottom() - getHeight();</span><br><span class="line">                    offsetChildrenVertical(canScroll*-<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">View</span>  <span class="variable">firView</span> <span class="operator">=</span> getChildAt(<span class="number">0</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">firstPos</span> <span class="operator">=</span> getPosition(firView);</span><br><span class="line">            <span class="keyword">if</span> (firstPos &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (firView.getTop() - dy &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                    canScroll = firView.getTop();</span><br><span class="line">                    offsetChildrenVertical(canScroll*-<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//底部填充</span></span><br><span class="line">        fill(dy,recycler,state);</span><br><span class="line">        <span class="comment">//滚动</span></span><br><span class="line">        offsetChildrenVertical(dy*-<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//回收已经离开界面的</span></span><br><span class="line">        recycleOut(dy,recycler,state);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> dy;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fill</span><span class="params">(<span class="type">int</span> dy, RecyclerView.Recycler recycler, RecyclerView.State state)</span>&#123;</span><br><span class="line">        <span class="comment">//向下滚动</span></span><br><span class="line">        <span class="keyword">if</span> (dy &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//先在底部填充</span></span><br><span class="line">            <span class="type">View</span>  <span class="variable">lastView</span> <span class="operator">=</span> getChildAt(getChildCount() -<span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">lastPos</span> <span class="operator">=</span> getPosition(lastView);</span><br><span class="line">            <span class="keyword">if</span> (lastPos == getChildCount()-<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;lastView top&quot;</span> + lastView.getTop() + <span class="string">&quot; bottom &quot;</span> + lastView.getBottom());</span><br><span class="line">            <span class="keyword">if</span> (lastView.getBottom() -  dy &lt; getHeight())&#123;</span><br><span class="line">                <span class="type">View</span> <span class="variable">scrap</span> <span class="operator">=</span> recycler.getViewForPosition(lastPos+<span class="number">1</span>);</span><br><span class="line">                addView(scrap);</span><br><span class="line">                measureChildWithMargins(scrap,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> getDecoratedMeasuredWidth(scrap);</span><br><span class="line">                <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> getDecoratedMeasuredHeight(scrap);</span><br><span class="line">                layoutDecorated(scrap,<span class="number">0</span>,lastView.getBottom(),width,lastView.getBottom()+height);</span><br><span class="line"><span class="comment">//                bottomItemPos++;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//向上滚动</span></span><br><span class="line">            <span class="comment">//现在顶部填充</span></span><br><span class="line">            <span class="type">View</span>  <span class="variable">firstView</span> <span class="operator">=</span> getChildAt(<span class="number">0</span>);</span><br><span class="line">            Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;firstView top&quot;</span> + firstView.getTop() + <span class="string">&quot; bottom &quot;</span> + firstView.getBottom());</span><br><span class="line">            <span class="type">int</span> <span class="variable">layoutPostion</span> <span class="operator">=</span> getPosition(firstView);</span><br><span class="line">            <span class="keyword">if</span> (layoutPostion == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (firstView.getTop() &gt;= <span class="number">0</span> )&#123;</span><br><span class="line">                <span class="type">View</span> <span class="variable">scrap</span> <span class="operator">=</span> recycler.getViewForPosition(layoutPostion -<span class="number">1</span>);</span><br><span class="line">                addView(scrap,<span class="number">0</span>);</span><br><span class="line">                measureChildWithMargins(scrap,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> getDecoratedMeasuredWidth(scrap);</span><br><span class="line">                <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> getDecoratedMeasuredHeight(scrap);</span><br><span class="line">                layoutDecorated(scrap,<span class="number">0</span>,firstView.getTop() - height,width,firstView.getTop());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">recycleOut</span><span class="params">(<span class="type">int</span> dy, RecyclerView.Recycler recycler, RecyclerView.State state)</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt;getChildCount() ;i++)&#123;</span><br><span class="line">                <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> getChildAt(i);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//            Log.d(&quot;feifeifei&quot;,&quot;recycleOut position &quot;+ i + &quot; getDecoratedTop &quot; + getDecoratedTop(view) + &quot; getDecoratedBottom &quot; + getDecoratedBottom(view));</span></span><br><span class="line">                Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;recycleOut position &quot;</span>+ i + <span class="string">&quot; top &quot;</span> + view.getTop() + <span class="string">&quot; bottom &quot;</span> + view.getBottom());</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span> (dy &gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span> (view.getBottom()-dy &lt;<span class="number">0</span>)&#123;</span><br><span class="line">                        Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;recycleOut &quot;</span> + i);</span><br><span class="line">                        removeAndRecycleView(view,recycler);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (view.getTop()-dy &gt; getHeight())&#123;</span><br><span class="line">                        Log.d(<span class="string">&quot;feifeifei&quot;</span>,<span class="string">&quot;recycleOut &quot;</span> + i);</span><br><span class="line">                        removeAndRecycleView(view,recycler);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后通过adapter打印日志,onCreateViewHolder只打印了7次(我的界面上显示的7个item),然后滚动界面的时候,onBindViewHolder依次打印.看来回收还是成功的.这样一个简单版的带回收的LinearLayoutManager就好了</p>
<h2 id="Resources-和-AssetManager"><a href="#Resources-和-AssetManager" class="headerlink" title="Resources 和 AssetManager"></a>Resources 和 AssetManager</h2><p>在 Android 开发中我们使用 Resources 来获取 res 目录下的各种与设备相关的资源。而使用 AssetManager 来获取 assets 目录下的资源。<br>一般来说 Resources 对象通过 Context 获得。<br>appContext 中的 resources 是在创建之后通过如下代码设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.setResources(packageInfo.getResources());</span><br></pre></td></tr></table></figure>
<p>而 LoadedApk 中则是通过如下代码创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mResources = ResourcesManager.getInstance().getResources(<span class="literal">null</span>, mResDir,</span><br><span class="line">        splitPaths, mOverlayDirs, mApplicationInfo.sharedLibraryFiles,</span><br><span class="line">        Display.DEFAULT_DISPLAY, <span class="literal">null</span>, getCompatibilityInfo(),</span><br><span class="line">        getClassLoader());</span><br></pre></td></tr></table></figure>
<p>其中 mResDir 对应 ApplicationInfo.sourceDir 字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Full path to the base APK for this application.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String sourceDir;</span><br></pre></td></tr></table></figure>
<p>ResourcesManager.getInstance().getResources 的主要逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">ResourcesKey</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourcesKey</span>(</span><br><span class="line">                   resDir,</span><br><span class="line">                   splitResDirs,</span><br><span class="line">                   overlayDirs,</span><br><span class="line">                   libDirs,</span><br><span class="line">                   displayId,</span><br><span class="line">                   overrideConfig != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">Configuration</span>(overrideConfig) : <span class="literal">null</span>, <span class="comment">// Copy</span></span><br><span class="line">                   compatInfo);</span><br><span class="line">           classLoader = classLoader != <span class="literal">null</span> ? classLoader : ClassLoader.getSystemClassLoader();</span><br><span class="line">           <span class="keyword">return</span> getOrCreateResources(activityToken, key, classLoader);</span><br></pre></td></tr></table></figure>
<p>getOrCreateResources 主要逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="comment">// 1) 先创建 ResourcesImpl</span></span><br><span class="line"> <span class="type">ResourcesImpl</span> <span class="variable">resourcesImpl</span> <span class="operator">=</span> createResourcesImpl(key);</span><br><span class="line"><span class="comment">// 2) 再创建 Resources</span></span><br><span class="line"> resources = getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br></pre></td></tr></table></figure>
<p>createResourcewImpl 主要逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">final</span> <span class="type">AssetManager</span> <span class="variable">assets</span> <span class="operator">=</span> createAssetManager(key);</span><br><span class="line">      <span class="keyword">if</span> (assets == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">final</span> <span class="type">DisplayMetrics</span> <span class="variable">dm</span> <span class="operator">=</span> getDisplayMetrics(key.mDisplayId, daj);</span><br><span class="line">      <span class="keyword">final</span> <span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> generateConfig(key, dm);</span><br><span class="line">      <span class="keyword">final</span> <span class="type">ResourcesImpl</span> <span class="variable">impl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourcesImpl</span>(assets, dm, config, daj);</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">return</span> impl;</span><br></pre></td></tr></table></figure>
<p>其中 createAssetManager(key) 的主要逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 1） 创建 assets 对象实例。</span></span><br><span class="line">  <span class="type">AssetManager</span> <span class="variable">assets</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AssetManager</span>();</span><br><span class="line"><span class="comment">// 2) 添加各资源目录。</span></span><br><span class="line">assets.addAssetPath(key.mResDir)</span><br><span class="line">assets.addAssetPath(splitResDir) </span><br><span class="line">assets.addOverlayPath(idmapPath);</span><br><span class="line">assets.addAssetPathAsSharedLibrary(libDir) </span><br></pre></td></tr></table></figure>
<p>最终 Resources 的创建逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// getOrCreateResourcesLocked</span></span><br><span class="line">        <span class="type">Resources</span> <span class="variable">resources</span> <span class="operator">=</span> compatInfo.needsCompatResources() ? <span class="keyword">new</span> <span class="title class_">CompatResources</span>(classLoader)</span><br><span class="line">                : <span class="keyword">new</span> <span class="title class_">Resources</span>(classLoader);</span><br><span class="line">        resources.setImpl(impl);</span><br></pre></td></tr></table></figure>
<h3 id="以-Resouces-getString-来查看资源的读取流程"><a href="#以-Resouces-getString-来查看资源的读取流程" class="headerlink" title="以 Resouces.getString 来查看资源的读取流程"></a>以 Resouces.getString 来查看资源的读取流程</h3><p>1）调用 getText</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getString</span><span class="params">(<span class="meta">@StringRes</span> <span class="type">int</span> id)</span> <span class="keyword">throws</span> NotFoundException &#123;</span><br><span class="line">       <span class="keyword">return</span> getText(id).toString();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>2）通过 resourcesImpl 调用 AssetsManager 的 getResourceText</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span> <span class="keyword">public</span> CharSequence <span class="title function_">getText</span><span class="params">(<span class="meta">@StringRes</span> <span class="type">int</span> id)</span> <span class="keyword">throws</span> NotFoundException &#123;</span><br><span class="line">    <span class="type">CharSequence</span> <span class="variable">res</span> <span class="operator">=</span> mResourcesImpl.getAssets().getResourceText(id);</span><br><span class="line">    <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NotFoundException</span>(<span class="string">&quot;String resource ID #0x&quot;</span></span><br><span class="line">            + Integer.toHexString(id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3）getResourceText</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"> <span class="keyword">final</span> CharSequence <span class="title function_">getResourceText</span><span class="params">(<span class="meta">@StringRes</span> <span class="type">int</span> resId)</span> &#123;</span><br><span class="line">     <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="type">TypedValue</span> <span class="variable">outValue</span> <span class="operator">=</span> mValue;</span><br><span class="line">         <span class="keyword">if</span> (getResourceValue(resId, <span class="number">0</span>, outValue, <span class="literal">true</span>)) &#123;</span><br><span class="line">             <span class="keyword">return</span> outValue.coerceToString();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>4）getResourceValue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">getResourceValue</span><span class="params">(<span class="meta">@AnyRes</span> <span class="type">int</span> resId, <span class="type">int</span> densityDpi, <span class="meta">@NonNull</span> TypedValue outValue,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> resolveRefs)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">block</span> <span class="operator">=</span> loadResourceValue(resId, (<span class="type">short</span>) densityDpi, outValue, resolveRefs);</span><br><span class="line">        <span class="keyword">if</span> (block &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Convert the changing configurations flags populated by native code.</span></span><br><span class="line">        outValue.changingConfigurations = ActivityInfo.activityInfoConfigNativeToJava(</span><br><span class="line">                outValue.changingConfigurations);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (outValue.type == TypedValue.TYPE_STRING) &#123;</span><br><span class="line">            outValue.string = mStringBlocks[block].get(outValue.data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5）最后通过 loadResourceValue 这一原生方法读取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** Returns true if the resource was found, filling in mRetStringBlock and</span></span><br><span class="line"><span class="comment">  *  mRetData. */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">loadResourceValue</span><span class="params">(<span class="type">int</span> ident, <span class="type">short</span> density, TypedValue outValue,</span></span><br><span class="line"><span class="params">         <span class="type">boolean</span> resolve)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>王水泥</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://uncle2000.github.io/post/framework/FrameWork%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%90/">https://uncle2000.github.io/post/framework/FrameWork%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%90/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/blog/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/blog/post/Android/Android-RxJava%20&%20ioC%20DI%20&%20AOP/">Android-RxJava & ioC DI & AOP</a>
            
            
            <a class="next" rel="next" href="/blog/post/java/Java%20VM/">Java VM</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© 王水泥 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>